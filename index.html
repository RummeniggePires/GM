<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGM Dashboard ¬∑ Energisa</title>
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #0d1117;
  --surface:  #161b22;
  --surface2: #1c2129;
  --border:   #21262d;
  --accent:   #2f81f7;
  --green:    #3fb950;
  --red:      #f85149;
  --text:     #e6edf3;
  --text2:    #8b949e;
  --text3:    #484f58;
  --font:     'Geist', 'Inter', system-ui, sans-serif;
  --mono:     'IBM Plex Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  min-height: 100vh;
  font-size: 14px;
  -webkit-font-smoothing: antialiased;
}

.screen { display: none; }
.screen.active { display: block; }
#screenLoading.active, #screenError.active { display: flex; }

/* ‚ïê‚ïê UPLOAD ‚ïê‚ïê */
#screenUpload.active {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 24px;
}

.upload-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 40px;
  width: 100%;
  max-width: 460px;
}

.upload-logo {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 32px;
}

.logo-icon {
  width: 40px; height: 40px;
  background: var(--accent);
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 18px; color: #fff;
  flex-shrink: 0;
}

.logo-text strong { display: block; font-size: 16px; font-weight: 700; color: var(--text); }
.logo-text span { font-size: 11px; color: var(--text2); margin-top: 1px; display: block; }

.field-label {
  font-size: 11px; font-weight: 500; color: var(--text2);
  margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.8px;
}

.drop-zone {
  border: 2px dashed var(--border);
  border-radius: 8px; padding: 40px 20px;
  text-align: center; cursor: pointer;
  position: relative;
  transition: border-color 0.2s, background 0.2s;
  margin-bottom: 20px;
}

.drop-zone:hover, .drop-zone.over {
  border-color: var(--accent);
  background: rgba(47,129,247,0.04);
}

.drop-zone input[type="file"] {
  position: absolute; inset: 0; opacity: 0;
  cursor: pointer; width: 100%; height: 100%;
}

.drop-icon { font-size: 32px; margin-bottom: 10px; display: block; }

.drop-main { font-size: 13px; color: var(--text2); line-height: 1.6; }
.drop-main strong { color: var(--accent); }

.file-selected {
  display: none; margin-top: 10px; font-size: 12px;
  color: var(--green); gap: 6px; align-items: center; justify-content: center;
}
.file-selected.show { display: flex; }

.btn-upload {
  width: 100%; background: var(--accent); color: #fff;
  border: none; font-family: var(--font); font-weight: 600;
  font-size: 14px; padding: 12px; border-radius: 8px;
  cursor: pointer; transition: opacity 0.15s;
}
.btn-upload:hover { opacity: 0.88; }
.btn-upload:disabled { opacity: 0.35; cursor: not-allowed; }

.upload-note {
  margin-top: 14px; font-size: 11px; color: var(--text3);
  text-align: center; line-height: 1.7;
}

/* ‚ïê‚ïê LOADING ‚ïê‚ïê */
#screenLoading {
  min-height: 100vh; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 20px; padding: 40px;
}

.spinner {
  width: 40px; height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.75s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.loading-title { font-size: 16px; font-weight: 600; color: var(--text); }

.loading-steps { display: flex; flex-direction: column; gap: 8px; min-width: 260px; }

.lstep { display: flex; align-items: center; gap: 10px; font-size: 12px; color: var(--text3); transition: color 0.3s; }
.lstep.active { color: var(--accent); }
.lstep.done   { color: var(--green); }
.lstep-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--border); flex-shrink: 0; transition: background 0.3s; }
.lstep.active .lstep-dot { background: var(--accent); }
.lstep.done   .lstep-dot { background: var(--green); }

/* ‚ïê‚ïê ERROR ‚ïê‚ïê */
#screenError {
  min-height: 100vh; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 14px; padding: 40px;
}
.err-icon { font-size: 44px; }
.err-title { font-size: 18px; font-weight: 700; color: var(--red); }
.err-box {
  background: rgba(248,81,73,0.07); border: 1px solid rgba(248,81,73,0.2);
  border-radius: 8px; padding: 14px 20px; font-size: 12px;
  color: var(--text2); line-height: 1.7; max-width: 440px; text-align: center;
}
.btn-back {
  background: none; border: 1px solid var(--border); color: var(--text2);
  font-family: var(--font); font-size: 12px; padding: 9px 20px;
  border-radius: 6px; cursor: pointer; margin-top: 4px; transition: all 0.15s;
}
.btn-back:hover { border-color: var(--text2); color: var(--text); }

/* ‚ïê‚ïê HEADER ‚ïê‚ïê */
header {
  padding: 16px 32px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  gap: 16px; flex-wrap: wrap;
}
.hd-left { display: flex; align-items: center; gap: 12px; }
.hd-title { font-size: 15px; font-weight: 700; color: var(--text); }
.hd-sub   { font-size: 11px; color: var(--text2); margin-top: 1px; }
.hd-right { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

.tag {
  font-size: 11px; font-family: var(--mono); padding: 4px 10px;
  border-radius: 4px; background: rgba(47,129,247,0.1);
  border: 1px solid rgba(47,129,247,0.25); color: var(--accent);
}

.btn-nova {
  background: none; border: 1px solid var(--border); color: var(--text3);
  font-family: var(--font); font-size: 11px; padding: 6px 14px;
  border-radius: 6px; cursor: pointer; transition: all 0.15s;
}
.btn-nova:hover { border-color: var(--red); color: var(--red); }

/* ‚ïê‚ïê STATS ‚ïê‚ïê */
.stats-row {
  display: grid; grid-template-columns: repeat(3, 1fr);
  border-bottom: 1px solid var(--border);
  background: var(--border); gap: 1px;
}
.stat-card {
  background: var(--surface); padding: 16px 24px;
  cursor: pointer; transition: background 0.12s;
}
.stat-card:hover, .stat-card.on { background: var(--surface2); }
.sc-label {
  font-size: 10px; text-transform: uppercase; letter-spacing: 1px;
  color: var(--text3); margin-bottom: 6px;
  display: flex; align-items: center; gap: 6px;
}
.dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.sc-value { font-size: 28px; font-weight: 800; line-height: 1; }
.c-total  { color: var(--text); }
.c-aprov  { color: var(--green); }
.c-cancel { color: var(--red); }
.d-total  { background: var(--accent); }
.d-aprov  { background: var(--green); }
.d-cancel { background: var(--red); }

/* ‚ïê‚ïê CONTROLS ‚ïê‚ïê */
.controls {
  padding: 12px 32px; display: flex; gap: 10px;
  align-items: center; flex-wrap: wrap;
  border-bottom: 1px solid var(--border);
}
.sw { position: relative; flex: 1; min-width: 200px; }
.sw input {
  width: 100%; background: var(--surface); border: 1px solid var(--border);
  color: var(--text); font-family: var(--font); font-size: 12px;
  padding: 8px 12px 8px 34px; border-radius: 6px; outline: none; transition: border-color 0.15s;
}
.sw input:focus { border-color: var(--accent); }
.sw input::placeholder { color: var(--text3); }
.sw-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text3); font-size: 14px; pointer-events: none; }

select {
  background: var(--surface); border: 1px solid var(--border);
  color: var(--text); font-family: var(--font); font-size: 11px;
  padding: 8px 28px 8px 11px; border-radius: 6px; outline: none;
  cursor: pointer; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%238b949e' d='M5 7L1 2h8z'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 9px center;
  transition: border-color 0.15s;
}
select:focus { border-color: var(--accent); }
.rc { font-size: 11px; color: var(--text3); white-space: nowrap; }

/* ‚ïê‚ïê TABLE ‚ïê‚ïê */
.tbl-wrap { padding: 0 32px 48px; overflow-x: auto; }
table { width: 100%; border-collapse: collapse; margin-top: 16px; }
thead th {
  text-align: left; font-size: 10px; font-weight: 500;
  text-transform: uppercase; letter-spacing: 1px; color: var(--text3);
  padding: 8px 10px; border-bottom: 1px solid var(--border); white-space: nowrap;
}
tbody tr { border-bottom: 1px solid rgba(33,38,45,0.8); transition: background 0.1s; cursor: pointer; }
tbody tr:hover { background: var(--surface2); }
tbody td { padding: 10px 10px; font-size: 12px; color: var(--text2); vertical-align: middle; }

.td-num  { font-family: var(--mono); font-size: 12px; font-weight: 500; color: var(--accent); white-space: nowrap; }
.td-cat  { font-size: 10px; background: rgba(255,255,255,0.04); border: 1px solid var(--border); color: var(--text3); padding: 2px 7px; border-radius: 4px; white-space: nowrap; display: inline-block; }
.td-assunto { max-width: 260px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text); font-size: 12px; }
.td-time { font-family: var(--mono); font-size: 11px; white-space: nowrap; }
.td-dur  { font-family: var(--mono); font-size: 11px; color: #58a6ff; white-space: nowrap; }

.badge { display: inline-flex; align-items: center; gap: 5px; font-size: 10px; font-weight: 500; padding: 3px 8px; border-radius: 20px; white-space: nowrap; }
.badge-aprov  { background: rgba(63,185,80,0.12);  color: var(--green); border: 1px solid rgba(63,185,80,0.3); }
.badge-cancel { background: rgba(248,81,73,0.12);  color: var(--red);   border: 1px solid rgba(248,81,73,0.3); }
.badge-dot    { width: 5px; height: 5px; border-radius: 50%; background: currentColor; flex-shrink: 0; }

.empty { text-align: center; padding: 56px 20px; color: var(--text3); font-size: 13px; }
.empty-icon { font-size: 32px; margin-bottom: 10px; }

/* ‚ïê‚ïê MODAL ‚ïê‚ïê */
.overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.7); z-index: 200;
  align-items: center; justify-content: center; padding: 20px;
}
.overlay.open { display: flex; }

.modal {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; max-width: 560px; width: 100%;
  max-height: 88vh; overflow-y: auto; padding: 26px;
  position: relative; animation: fadeUp 0.16s ease;
}
@keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

.modal-x { position: absolute; top: 14px; right: 14px; background: none; border: none; color: var(--text3); font-size: 18px; cursor: pointer; padding: 4px 8px; border-radius: 4px; line-height: 1; transition: color 0.12s; }
.modal-x:hover { color: var(--text); }

.m-num-tag { font-family: var(--mono); font-size: 10px; color: var(--accent); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 6px; }
.m-title   { font-size: 15px; font-weight: 700; color: var(--text); line-height: 1.4; margin-bottom: 20px; padding-right: 28px; }
.m-grid    { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

.mf { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px 12px; }
.mf.full { grid-column: span 2; }
.mf-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: var(--text3); margin-bottom: 4px; font-weight: 500; }
.mf-val   { font-size: 12px; color: var(--text); font-weight: 500; line-height: 1.5; }

::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê UPLOAD ‚ïê‚ïê -->
<div id="screenUpload" class="screen active">
  <div class="upload-card">
    <div class="upload-logo">
      <div class="logo-icon">E</div>
      <div class="logo-text">
        <strong>CGM Dashboard</strong>
        <span>Comit√™ de Mudan√ßas de TI ¬∑ Energisa</span>
      </div>
    </div>
    <div class="field-label">Arquivo da ATA (PDF)</div>
    <div class="drop-zone" id="dropZone">
      <input type="file" id="pdfInput" accept=".pdf" onchange="onFile(this)">
      <span class="drop-icon">üìã</span>
      <div class="drop-main"><strong>Clique para selecionar</strong> ou arraste o PDF aqui</div>
      <div class="file-selected" id="fileSelected"><span>‚úì</span><span id="fileName"></span></div>
    </div>
    <button class="btn-upload" id="btnProcess" onclick="process()" disabled>Processar ATA ‚Üí</button>
    <p class="upload-note">Tudo roda no seu browser. Nenhum dado √© enviado para servidores externos.</p>
  </div>
</div>

<!-- ‚ïê‚ïê LOADING ‚ïê‚ïê -->
<div id="screenLoading" class="screen">
  <div class="spinner"></div>
  <div class="loading-title">Lendo a ATA...</div>
  <div class="loading-steps">
    <div class="lstep active" id="ls1"><div class="lstep-dot"></div>Carregando PDF</div>
    <div class="lstep"        id="ls2"><div class="lstep-dot"></div>Extraindo texto</div>
    <div class="lstep"        id="ls3"><div class="lstep-dot"></div>Identificando GMs</div>
    <div class="lstep"        id="ls4"><div class="lstep-dot"></div>Montando dashboard</div>
  </div>
</div>

<!-- ‚ïê‚ïê ERROR ‚ïê‚ïê -->
<div id="screenError" class="screen">
  <div class="err-icon">‚ö†Ô∏è</div>
  <div class="err-title">Algo deu errado</div>
  <div class="err-box" id="errMsg"></div>
  <button class="btn-back" onclick="goBack()">‚Üê Tentar novamente</button>
</div>

<!-- ‚ïê‚ïê DASHBOARD ‚ïê‚ïê -->
<div id="screenDash" class="screen">
  <header>
    <div class="hd-left">
      <div class="logo-icon">E</div>
      <div>
        <div class="hd-title" id="dTitle">Comit√™ de Mudan√ßas de TI</div>
        <div class="hd-sub"   id="dSub">‚Äî</div>
      </div>
    </div>
    <div class="hd-right">
      <span class="tag" id="dTag">‚Äî</span>
      <button class="btn-nova" onclick="goBack()">‚Ü© Nova ATA</button>
    </div>
  </header>

  <div class="stats-row">
    <div class="stat-card on" onclick="setStatus('all',this)">
      <div class="sc-label"><span class="dot d-total"></span>Total de GMs</div>
      <div class="sc-value c-total" id="sTotal">‚Äî</div>
    </div>
    <div class="stat-card" onclick="setStatus('aprovada',this)">
      <div class="sc-label"><span class="dot d-aprov"></span>Aprovadas</div>
      <div class="sc-value c-aprov" id="sAprov">‚Äî</div>
    </div>
    <div class="stat-card" onclick="setStatus('cancelada',this)">
      <div class="sc-label"><span class="dot d-cancel"></span>Canceladas</div>
      <div class="sc-value c-cancel" id="sCancel">‚Äî</div>
    </div>
  </div>

  <div class="controls">
    <div class="sw">
      <span class="sw-icon">‚åï</span>
      <input type="text" id="search" placeholder="Buscar por GM, assunto, respons√°vel..." oninput="filter()">
    </div>
    <select id="selCat"  onchange="filter()"><option value="">Todas as categorias</option></select>
    <select id="selDate" onchange="filter()"><option value="">Todas as datas</option></select>
    <select id="selSort" onchange="filter()">
      <option value="num">Ordenar: N¬∫ GM</option>
      <option value="inicio">Ordenar: In√≠cio</option>
      <option value="dur">Ordenar: Dura√ß√£o</option>
    </select>
    <span class="rc" id="rc"></span>
  </div>

  <div class="tbl-wrap">
    <table>
      <thead>
        <tr>
          <th>N¬∫ GM</th><th>Cat.</th><th>Assunto</th><th>Resp. T√©cnico</th>
          <th>In√≠cio</th><th>T√©rmino</th><th>Dura√ß√£o</th><th>Status</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="empty" id="empty" style="display:none">
      <div class="empty-icon">‚ó´</div>
      Nenhuma GM encontrada para os filtros aplicados.
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê MODAL ‚ïê‚ïê -->
<div class="overlay" id="overlay" onclick="closeMd(event)">
  <div class="modal">
    <button class="modal-x" onclick="closeMd()">‚úï</button>
    <div class="m-num-tag" id="mNum"></div>
    <div class="m-title"   id="mTit"></div>
    <div class="m-grid">
      <div class="mf"><div class="mf-label">Categoria</div><div class="mf-val" id="mCat"></div></div>
      <div class="mf"><div class="mf-label">Status</div><div class="mf-val" id="mSt"></div></div>
      <div class="mf"><div class="mf-label">In√≠cio Previsto</div><div class="mf-val" id="mIni"></div></div>
      <div class="mf"><div class="mf-label">T√©rmino Previsto</div><div class="mf-val" id="mFim"></div></div>
      <div class="mf"><div class="mf-label">Dura√ß√£o Prevista</div><div class="mf-val" id="mDur"></div></div>
      <div class="mf full"><div class="mf-label">Respons√°vel T√©cnico</div><div class="mf-val" id="mRtec"></div></div>
      <div class="mf full"><div class="mf-label">Respons√°vel</div><div class="mf-val" id="mResp"></div></div>
      <div class="mf full" id="mSistW"><div class="mf-label">Sistemas Afetados</div><div class="mf-val" id="mSist"></div></div>
      <div class="mf full" id="mClsW"><div class="mf-label">Classifica√ß√£o</div><div class="mf-val" id="mCls"></div></div>
      <div class="mf full" id="mMotW"><div class="mf-label">Motivo do Cancelamento</div><div class="mf-val" id="mMot" style="color:var(--red)"></div></div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let ALL = [], VIS = [], STATUS = 'all';

// ‚îÄ‚îÄ Upload ‚îÄ‚îÄ
const dz = document.getElementById('dropZone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('over'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('over');
  const f = e.dataTransfer.files[0];
  if (f?.type === 'application/pdf') assignFile(f);
});

function onFile(inp) { if (inp.files[0]) assignFile(inp.files[0]); }

function assignFile(f) {
  const dt = new DataTransfer(); dt.items.add(f);
  document.getElementById('pdfInput').files = dt.files;
  document.getElementById('fileName').textContent = f.name;
  document.getElementById('fileSelected').classList.add('show');
  document.getElementById('btnProcess').disabled = false;
}

function goBack() {
  ALL = []; VIS = []; STATUS = 'all';
  document.getElementById('pdfInput').value = '';
  document.getElementById('fileSelected').classList.remove('show');
  document.getElementById('btnProcess').disabled = true;
  show('screenUpload');
}

function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function step(n) {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('ls' + i);
    el.className = 'lstep' + (i < n ? ' done' : i === n ? ' active' : '');
  }
}

// ‚îÄ‚îÄ Process ‚îÄ‚îÄ
async function process() {
  const file = document.getElementById('pdfInput').files[0];
  if (!file) return;
  show('screenLoading'); step(1);
  try {
    const buf = await file.arrayBuffer();
    step(2);
    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
    let txt = '';
    for (let i = 1; i <= pdf.numPages; i++) {
      const pg   = await pdf.getPage(i);
      const cont = await pg.getTextContent();
      txt += cont.items.map(it => it.str).join(' ') + '\n';
    }
    step(3);
    const meta = parseMeta(txt);
    const gms  = parseGMs(txt);
    if (!gms.length) throw new Error('Nenhuma GM encontrada. Verifique se o arquivo √© uma ATA do CGM no formato padr√£o.');
    step(4);
    await sleep(300);
    buildDash(meta, gms);
    show('screenDash');
  } catch(e) {
    document.getElementById('errMsg').textContent = e.message || String(e);
    show('screenError');
  }
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ‚îÄ‚îÄ Parsers ‚îÄ‚îÄ
function parseMeta(txt) {
  const m = {};
  const mAta = txt.match(/Ata\s+n[¬∞¬∫\.]\s*(\d+[\/-]\d+)/i) || txt.match(/REUNI[A√É]O\s+N[¬∞¬∫]\s*(\d+\/\d+)/i);
  if (mAta) m.ata = mAta[1];
  const mData = txt.match(/(\d{2}\/\d{2}\/\d{4})/);
  if (mData) m.data = mData[1];
  const mHora = txt.match(/(\d{2}:\d{2})\s*(h|hs)?/i);
  if (mHora) m.hora = mHora[1];
  if (/teams/i.test(txt)) m.local = 'Microsoft Teams';
  else if (/zoom/i.test(txt)) m.local = 'Zoom';
  else if (/meet/i.test(txt)) m.local = 'Google Meet';
  return m;
}

function parseGMs(txt) {
  const norm = txt.replace(/\s+/g, ' ');
  const gmRe = /\b(\d{5,6})\b/g;
  let m; const seen = new Set(); const pts = [];
  while ((m = gmRe.exec(norm)) !== null) {
    const n = parseInt(m[1]);
    if (n >= 40000 && n <= 99999 && !seen.has(n)) { seen.add(n); pts.push({ n, idx: m.index }); }
  }
  return pts.map((p, i) => {
    const chunk = norm.slice(p.idx, pts[i+1] ? pts[i+1].idx : Math.min(p.idx + 900, norm.length));
    return extractGM(p.n, chunk);
  }).filter(Boolean);
}

function extractGM(num, chunk) {
  const catMap = {'1':'1 - Sistema','2':'2 - Infraestrutura','3':'3 - Telecom (Dados)','4':'4 - Telecom (Telefonia e R√°dio)','5':'5 - Sistema (Banco de Dados)','6':'6 - Sistema (Infraestrutura)','7':'7 - Telecom (Infraestrutura)','8':'8 - Sistema'};

  // Categoria
  let cat = '';
  const cm = chunk.match(/\b([1-8])\s*[-‚Äì]\s*(Sistema|Infraestrutura|Telecom)/i);
  if (cm) cat = catMap[cm[1]] || cm[0];
  else { const cn = chunk.match(/\b([1-8])\b/); if (cn && catMap[cn[1]]) cat = catMap[cn[1]]; }

  // Datas
  const dateRe = /(\d{2}\/\d{2}\/\d{4})\s+(\d{2}:\d{2})/g;
  const dates = []; let dm;
  while ((dm = dateRe.exec(chunk)) !== null) dates.push(dm[1] + ' ' + dm[2]);
  const inicio = dates[0] || '', termino = dates[1] || '';

  // Dura√ß√£o
  const durM = chunk.match(/(\d+[,\.]\d+|\d+)\s*h\b/i);
  const duracao = durM ? durM[1].replace('.', ',') + 'h' : '';

  // Status
  const status = /cancelad[ao]/i.test(chunk) ? 'cancelada' : 'aprovada';

  // Motivo
  let motivo = '';
  if (status === 'cancelada') {
    const mot = chunk.match(/[Cc]ancelad[ao][^.]{0,10}[-‚Äì:]\s*([^.]{5,100})/);
    if (mot) motivo = mot[1].trim();
    else {
      const mot2 = chunk.match(/[Cc]ancelad[ao]\s+([A-Za-z][^.]{5,80})/);
      if (mot2) motivo = mot2[1].trim();
    }
  }

  // Assunto ‚Äî texto ap√≥s o n√∫mero GM, antes da primeira data
  const numStr = String(num);
  const afterNum = chunk.slice(chunk.indexOf(numStr) + numStr.length).trim();
  let assunto = afterNum.split(/\d{2}\/\d{2}\/\d{4}/)[0]
    .replace(/^[1-8]\s*[-‚Äì]\s*(Sistema|Infraestrutura|Telecom)[^\s]*/i, '')
    .replace(/^[1-8]\s+/, '')
    .trim().slice(0, 130).replace(/\s+/g,' ').trim();

  // Respons√°vel t√©cnico ‚Äî nome em MAI√öSCULAS
  let respTec = '';
  const rtM = chunk.match(/\b([A-Z√Å√Ä√Ç√É√â√ä√ç√ì√î√ï√ö√ú√á]{2,}(?:\s+[A-Z√Å√Ä√Ç√É√â√ä√ç√ì√î√ï√ö√ú√á]{2,}){1,4})\b/);
  if (rtM) respTec = rtM[1].trim().slice(0, 60);

  // Sistemas afetados
  let sistemas = '';
  const sisM = chunk.match(/[Ss]istemas?\s+[Aa]fetados?[:\s]+([^\n.]{5,120})/);
  if (sisM) sistemas = sisM[1].trim();

  // Classifica√ß√£o
  const clsM = chunk.match(/\b(CORRETIVA|MELHORIA|PREVENTIVA|EMERGENCIAL)\b/i);
  const classificacao = clsM ? clsM[1].toUpperCase() : '';

  return { num, cat, assunto, inicio, termino, duracao, respTec, resp: '', sistemas, classificacao, status, motivo };
}

// ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ
function buildDash(meta, gms) {
  ALL = gms;
  document.getElementById('dTitle').textContent = 'Comit√™ de Mudan√ßas de TI';
  document.getElementById('dSub').textContent   = `ATA N¬∫ ${meta.ata || '‚Äî'}` + (meta.local ? '  ¬∑  ' + meta.local : '');
  document.getElementById('dTag').textContent   = (meta.data || '‚Äî') + (meta.hora ? ' ¬∑ ' + meta.hora : '');
  document.getElementById('sTotal').textContent  = gms.length;
  document.getElementById('sAprov').textContent  = gms.filter(g => g.status === 'aprovada').length;
  document.getElementById('sCancel').textContent = gms.filter(g => g.status === 'cancelada').length;

  // Categorias
  const cats = [...new Set(gms.map(g => g.cat).filter(Boolean))].sort();
  const sc = document.getElementById('selCat');
  sc.innerHTML = '<option value="">Todas as categorias</option>';
  cats.forEach(c => { const o = document.createElement('option'); o.value = c.split(' - ')[0]; o.textContent = c; sc.appendChild(o); });

  // Datas din√¢micas
  const allDates = [...new Set(gms.flatMap(g => [g.inicio?.split(' ')[0], g.termino?.split(' ')[0]].filter(Boolean)))].sort((a,b) => toTs(a) - toTs(b));
  const sd = document.getElementById('selDate');
  sd.innerHTML = '<option value="">Todas as datas</option>';
  const days = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
  allDates.forEach(d => {
    const [dd,mm,yy] = d.split('/');
    const wd = days[new Date(`${yy}-${mm}-${dd}`).getDay()];
    const o = document.createElement('option'); o.value = d; o.textContent = `${d} ‚Äî ${wd}`; sd.appendChild(o);
  });

  STATUS = 'all';
  document.querySelectorAll('.stat-card').forEach((c, i) => c.classList.toggle('on', i === 0));
  filter();
}

// ‚îÄ‚îÄ Filters ‚îÄ‚îÄ
function setStatus(s, el) {
  STATUS = s;
  document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('on'));
  el.classList.add('on');
  filter();
}

function filter() {
  const q    = document.getElementById('search').value.toLowerCase();
  const cat  = document.getElementById('selCat').value;
  const date = document.getElementById('selDate').value;
  const sort = document.getElementById('selSort').value;

  VIS = ALL.filter(g => {
    const okSt   = STATUS === 'all' || g.status === STATUS;
    const okCat  = !cat  || (g.cat||'').startsWith(cat);
    const okDate = !date || (g.inicio||'').startsWith(date) || (g.termino||'').startsWith(date);
    const okQ    = !q || String(g.num).includes(q) || (g.assunto||'').toLowerCase().includes(q) || (g.respTec||'').toLowerCase().includes(q);
    return okSt && okCat && okDate && okQ;
  });

  if (sort === 'inicio') VIS.sort((a,b) => toTs(a.inicio?.split(' ')[0]) - toTs(b.inicio?.split(' ')[0]));
  else if (sort === 'dur') VIS.sort((a,b) => parseFloat((b.duracao||'0').replace(',','.')) - parseFloat((a.duracao||'0').replace(',','.')));
  else VIS.sort((a,b) => a.num - b.num);

  document.getElementById('rc').textContent = `${VIS.length} resultado${VIS.length !== 1 ? 's' : ''}`;
  renderTbl();
}

function toTs(d) {
  if (!d) return 0;
  const p = d.split('/');
  return p.length === 3 ? new Date(`${p[2]}-${p[1]}-${p[0]}`).getTime() : 0;
}

// ‚îÄ‚îÄ Table ‚îÄ‚îÄ
function renderTbl() {
  const tbody = document.getElementById('tbody');
  const empty = document.getElementById('empty');
  if (!VIS.length) { tbody.innerHTML = ''; empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  tbody.innerHTML = VIS.map(g => {
    const idx  = ALL.indexOf(g);
    const catN = (g.cat||'').split(' - ')[0];
    const bCls = g.status === 'aprovada' ? 'badge-aprov' : 'badge-cancel';
    const bTxt = g.status === 'aprovada' ? 'Aprovada' : 'Cancelada';
    return `<tr onclick="openMd(${idx})">
      <td class="td-num">${g.num}</td>
      <td><span class="td-cat">${catN||'‚Äî'}</span></td>
      <td><div class="td-assunto" title="${esc(g.assunto)}">${esc(g.assunto)||'‚Äî'}</div></td>
      <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px">${tc(g.respTec)||'‚Äî'}</td>
      <td class="td-time">${g.inicio||'‚Äî'}</td>
      <td class="td-time">${g.termino||'‚Äî'}</td>
      <td class="td-dur">${g.duracao||'‚Äî'}</td>
      <td><span class="badge ${bCls}"><span class="badge-dot"></span>${bTxt}</span></td>
    </tr>`;
  }).join('');
}

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
function openMd(idx) {
  const g = ALL[idx];
  document.getElementById('mNum').textContent  = `GM ¬∑ ${g.num}`;
  document.getElementById('mTit').textContent  = g.assunto || '‚Äî';
  document.getElementById('mCat').textContent  = g.cat || '‚Äî';
  document.getElementById('mSt').innerHTML     = `<span class="badge ${g.status==='aprovada'?'badge-aprov':'badge-cancel'}" style="font-size:11px"><span class="badge-dot"></span>${g.status==='aprovada'?'Aprovada':'Cancelada'}</span>`;
  document.getElementById('mIni').textContent  = g.inicio   || '‚Äî';
  document.getElementById('mFim').textContent  = g.termino  || '‚Äî';
  document.getElementById('mDur').textContent  = g.duracao  || '‚Äî';
  document.getElementById('mRtec').textContent = tc(g.respTec) || '‚Äî';
  document.getElementById('mResp').textContent = g.resp || '‚Äî';
  showMF('mSistW','mSist', g.sistemas);
  showMF('mClsW', 'mCls',  g.classificacao);
  const mw = document.getElementById('mMotW');
  if (g.status === 'cancelada') { mw.style.display = ''; document.getElementById('mMot').textContent = g.motivo || 'N√£o informado'; }
  else mw.style.display = 'none';
  document.getElementById('overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function showMF(wId, vId, val) {
  const w = document.getElementById(wId);
  if (val) { w.style.display = ''; document.getElementById(vId).textContent = val; }
  else w.style.display = 'none';
}

function closeMd(e) {
  if (!e || e.target === document.getElementById('overlay') || e.target.classList?.contains('modal-x')) {
    document.getElementById('overlay').classList.remove('open');
    document.body.style.overflow = '';
  }
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeMd({ target: document.getElementById('overlay') }); });

function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function tc(s)  { return (s||'').toLowerCase().replace(/\b\w/g, c => c.toUpperCase()); }
</script>
</body>
</html>
