<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGM Dashboard ¬∑ Energisa</title>
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #0d1117;
  --surface:  #161b22;
  --surface2: #1c2129;
  --border:   #21262d;
  --accent:   #2f81f7;
  --green:    #3fb950;
  --red:      #f85149;
  --text:     #e6edf3;
  --text2:    #8b949e;
  --text3:    #484f58;
  --font:     'Geist', 'Inter', system-ui, sans-serif;
  --mono:     'IBM Plex Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  min-height: 100vh;
  font-size: 14px;
  -webkit-font-smoothing: antialiased;
}

.screen { display: none; }
.screen.active { display: block; }
#screenLoading.active, #screenError.active { display: flex; }

/* ‚ïê‚ïê UPLOAD ‚ïê‚ïê */
#screenUpload.active {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 24px;
}

.upload-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 40px;
  width: 100%;
  max-width: 460px;
}

.upload-logo {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 32px;
}

.logo-icon {
  width: 40px; height: 40px;
  background: var(--accent);
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 18px; color: #fff;
  flex-shrink: 0;
}

.logo-text strong { display: block; font-size: 16px; font-weight: 700; color: var(--text); }
.logo-text span { font-size: 11px; color: var(--text2); margin-top: 1px; display: block; }

.field-label {
  font-size: 11px; font-weight: 500; color: var(--text2);
  margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.8px;
}

.drop-zone {
  border: 2px dashed var(--border);
  border-radius: 8px; padding: 40px 20px;
  text-align: center; cursor: pointer;
  position: relative;
  transition: border-color 0.2s, background 0.2s;
  margin-bottom: 20px;
}

.drop-zone:hover, .drop-zone.over {
  border-color: var(--accent);
  background: rgba(47,129,247,0.04);
}

.drop-zone input[type="file"] {
  position: absolute; inset: 0; opacity: 0;
  cursor: pointer; width: 100%; height: 100%;
}

.drop-icon { font-size: 32px; margin-bottom: 10px; display: block; }

.drop-main { font-size: 13px; color: var(--text2); line-height: 1.6; }
.drop-main strong { color: var(--accent); }

.file-selected {
  display: none; margin-top: 10px; font-size: 12px;
  color: var(--green); gap: 6px; align-items: center; justify-content: center;
}
.file-selected.show { display: flex; }

.btn-upload {
  width: 100%; background: var(--accent); color: #fff;
  border: none; font-family: var(--font); font-weight: 600;
  font-size: 14px; padding: 12px; border-radius: 8px;
  cursor: pointer; transition: opacity 0.15s;
}
.btn-upload:hover { opacity: 0.88; }
.btn-upload:disabled { opacity: 0.35; cursor: not-allowed; }

/* ‚ïê‚ïê LOADING ‚ïê‚ïê */
#screenLoading {
  min-height: 100vh; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 20px; padding: 40px;
}

.spinner {
  width: 40px; height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.75s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.loading-title { font-size: 16px; font-weight: 600; color: var(--text); }

/* ‚ïê‚ïê DASHBOARD ‚ïê‚ïê */
header {
  padding: 16px 32px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  gap: 16px; flex-wrap: wrap;
}
.hd-left { display: flex; align-items: center; gap: 12px; }
.hd-title { font-size: 15px; font-weight: 700; color: var(--text); }
.hd-sub   { font-size: 11px; color: var(--text2); margin-top: 1px; }

.stats-row {
  display: grid; grid-template-columns: repeat(3, 1fr);
  border-bottom: 1px solid var(--border);
  background: var(--border); gap: 1px;
}
.stat-card {
  background: var(--surface); padding: 16px 24px;
  cursor: pointer; transition: background 0.12s;
}
.stat-card:hover, .stat-card.on { background: var(--surface2); }
.sc-label {
  font-size: 10px; text-transform: uppercase; letter-spacing: 1px;
  color: var(--text3); margin-bottom: 6px;
  display: flex; align-items: center; gap: 6px;
}
.dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.sc-value { font-size: 28px; font-weight: 800; line-height: 1; }
.c-total  { color: var(--text); }
.c-aprov  { color: var(--green); }
.c-cancel { color: var(--red); }
.d-total  { background: var(--accent); }
.d-aprov  { background: var(--green); }
.d-cancel { background: var(--red); }

/* ‚ïê‚ïê CONTROLS ‚ïê‚ïê */
.controls {
  padding: 12px 32px; display: flex; gap: 10px;
  align-items: center; flex-wrap: wrap;
  border-bottom: 1px solid var(--border);
}
.sw { position: relative; flex: 1; min-width: 200px; }
.sw input {
  width: 100%; background: var(--surface); border: 1px solid var(--border);
  color: var(--text); font-family: var(--font); font-size: 12px;
  padding: 8px 12px 8px 34px; border-radius: 6px; outline: none; transition: border-color 0.15s;
}
.sw-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text3); font-size: 14px; pointer-events: none; }

/* ‚ïê‚ïê TABLE ‚ïê‚ïê */
.tbl-wrap { padding: 0 32px 48px; overflow-x: auto; }
table { width: 100%; border-collapse: collapse; margin-top: 16px; }
thead th {
  text-align: left; font-size: 10px; font-weight: 500;
  text-transform: uppercase; letter-spacing: 1px; color: var(--text3);
  padding: 8px 10px; border-bottom: 1px solid var(--border); white-space: nowrap;
}
tbody tr { border-bottom: 1px solid rgba(33,38,45,0.8); transition: background 0.1s; cursor: pointer; }
tbody tr:hover { background: var(--surface2); }
tbody td { padding: 10px 10px; font-size: 12px; color: var(--text2); vertical-align: middle; }

.td-num  { font-family: var(--mono); font-size: 12px; font-weight: 500; color: var(--accent); }
.td-dur  { font-family: var(--mono); font-size: 11px; color: #58a6ff; white-space: nowrap; }

.badge { display: inline-flex; align-items: center; gap: 5px; font-size: 10px; font-weight: 500; padding: 3px 8px; border-radius: 20px; white-space: nowrap; }
.badge-aprov  { background: rgba(63,185,80,0.12);  color: var(--green); border: 1px solid rgba(63,185,80,0.3); }
.badge-cancel { background: rgba(248,81,73,0.12);  color: var(--red);   border: 1px solid rgba(248,81,73,0.3); }
.badge-dot    { width: 5px; height: 5px; border-radius: 50%; background: currentColor; flex-shrink: 0; }

/* ‚ïê‚ïê MODAL ‚ïê‚ïê */
.overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.7); z-index: 200;
  align-items: center; justify-content: center; padding: 20px;
}
.overlay.open { display: flex; }
.modal {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; max-width: 560px; width: 100%;
  max-height: 88vh; overflow-y: auto; padding: 26px;
  position: relative;
}
.m-num-tag { font-family: var(--mono); font-size: 10px; color: var(--accent); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 6px; }
.m-title   { font-size: 15px; font-weight: 700; color: var(--text); line-height: 1.4; margin-bottom: 20px; }
.m-grid    { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.mf { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px 12px; }
.mf.full { grid-column: span 2; }
.mf-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: var(--text3); margin-bottom: 4px; }
.mf-val   { font-size: 12px; color: var(--text); font-weight: 500; }
</style>
</head>
<body>

<div id="screenUpload" class="screen active">
  <div class="upload-card">
    <div class="upload-logo">
      <div class="logo-icon">E</div>
      <div class="logo-text"><strong>CGM Dashboard</strong><span>Energisa</span></div>
    </div>
    <div class="field-label">Arquivo da ATA (PDF)</div>
    <div class="drop-zone" id="dropZone">
      <input type="file" id="pdfInput" accept=".pdf" onchange="onFile(this)">
      <span class="drop-icon">üìã</span>
      <div class="drop-main"><strong>Clique para selecionar</strong> ou arraste aqui</div>
      <div class="file-selected" id="fileSelected"><span>‚úì</span><span id="fileName"></span></div>
    </div>
    <button class="btn-upload" id="btnProcess" onclick="process()" disabled>Processar ATA ‚Üí</button>
  </div>
</div>

<div id="screenLoading" class="screen">
  <div class="spinner"></div>
  <div class="loading-title">Processando documentos...</div>
</div>

<div id="screenDash" class="screen">
  <header>
    <div class="hd-left">
      <div class="logo-icon">E</div>
      <div><div class="hd-title" id="dTitle">Comit√™ de Mudan√ßas</div><div class="hd-sub" id="dSub"></div></div>
    </div>
    <button class="btn-upload" style="width:auto; padding:6px 15px" onclick="location.reload()">Nova ATA</button>
  </header>

  <div class="stats-row">
    <div class="stat-card on" onclick="setStatus('all',this)">
      <div class="sc-label"><span class="dot d-total"></span>Total</div>
      <div class="sc-value c-total" id="sTotal">0</div>
    </div>
    <div class="stat-card" onclick="setStatus('aprovada',this)">
      <div class="sc-label"><span class="dot d-aprov"></span>Aprovadas</div>
      <div class="sc-value c-aprov" id="sAprov">0</div>
    </div>
    <div class="stat-card" onclick="setStatus('cancelada',this)">
      <div class="sc-label"><span class="dot d-cancel"></span>Canceladas</div>
      <div class="sc-value c-cancel" id="sCancel">0</div>
    </div>
  </div>

  <div class="controls">
    <div class="sw"><span class="sw-icon">‚åï</span><input type="text" id="search" placeholder="Buscar GM ou assunto..." oninput="filter()"></div>
  </div>

  <div class="tbl-wrap">
    <table>
      <thead>
        <tr><th>N¬∫ GM</th><th>Assunto</th><th>In√≠cio</th><th>Dura√ß√£o</th><th>Status</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<div class="overlay" id="overlay" onclick="closeMd(event)">
  <div class="modal">
    <div class="m-num-tag" id="mNum"></div>
    <div class="m-title" id="mTit"></div>
    <div class="m-grid">
      <div class="mf"><div class="mf-label">In√≠cio</div><div class="mf-val" id="mIni"></div></div>
      <div class="mf"><div class="mf-label">Dura√ß√£o</div><div class="mf-val" id="mDur"></div></div>
      <div class="mf full"><div class="mf-label">Respons√°vel T√©cnico</div><div class="mf-val" id="mRtec"></div></div>
      <div class="mf full" id="mMotW"><div class="mf-label">Motivo do Cancelamento</div><div class="mf-val" id="mMot" style="color:var(--red); font-weight:bold"></div></div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let ALL_GMS = [], VISIBLE_GMS = [], FILTER_STATUS = 'all';

function onFile(inp) {
  if (inp.files[0]) {
    document.getElementById('fileName').textContent = inp.files[0].name;
    document.getElementById('fileSelected').classList.add('show');
    document.getElementById('btnProcess').disabled = false;
  }
}

async function process() {
  const file = document.getElementById('pdfInput').files[0];
  if (!file) return;
  document.getElementById('screenUpload').classList.remove('active');
  document.getElementById('screenLoading').classList.add('active');

  try {
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
    let fullText = "";
    
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      fullText += content.items.map(s => s.str).join(' ') + "\n";
    }

    // Normaliza espa√ßos para facilitar regex
    const normalizedText = fullText.replace(/\s+/g, ' ');
    ALL_GMS = parseGMs(normalizedText);
    
    renderDash();
    document.getElementById('screenLoading').classList.remove('active');
    document.getElementById('screenDash').classList.add('active');
  } catch (e) {
    alert("Erro ao ler PDF: " + e.message);
    location.reload();
  }
}

function parseGMs(text) {
    // Divide o texto pelos n√∫meros de mudan√ßa (ex: 149) N√∫mero Mudan√ßa: 49982)
    const blocks = text.split(/\d+\)\s+N√∫mero Mudan√ßa:/g).slice(1);
    
    return blocks.map(block => {
        const gm = {};
        
        // N√∫mero da GM
        gm.num = block.match(/^\s*(\d+)/)?.[1] || "‚Äî";
        
        // Assunto (Texto entre o n√∫mero e "In√≠cio Previsto")
        gm.assunto = block.match(/\d+\s+(.*?)\s+In√≠cio Previsto/i)?.[1]?.trim() || "Sem assunto";

        // In√≠cio e T√©rmino
        gm.inicio = block.match(/In√≠cio Previsto:\s+([\d/: ]+)/)?.[1] || "‚Äî";
        gm.termino = block.match(/T√©rmino Previsto:\s+([\d/: ]+)/)?.[1] || "‚Äî";
        
        // Dura√ß√£o (Tempo de Execu√ß√£o) - Agora pegando corretamente
        gm.duracao = block.match(/Dura√ß√£o Prevista:\s*([^\n\r]+?)(?=Respons√°vel T√©cnico|Sistemas|$)/i)?.[1]?.trim() || "‚Äî";

        // Respons√°vel T√©cnico
        gm.respTec = block.match(/Respons√°vel T√©cnico:\s*([A-Z\s]+?)(?=Sistemas|Classifica√ß√£o|$)/i)?.[1]?.trim() || "‚Äî";

        // Status e Motivo do Cancelamento
        // O PDF indica cancelamento com "Cancelada pelo solicitante" ou frases similares ap√≥s a Classifica√ß√£o
        const cancelMatch = block.match(/Cancelada[\s\.].*?(?=\d+\)|$)/i);
        if (cancelMatch) {
            gm.status = 'cancelada';
            gm.motivo = cancelMatch[0].trim();
        } else {
            gm.status = 'aprovada';
            gm.motivo = '';
        }

        return gm;
    });
}

function renderDash() {
  document.getElementById('sTotal').textContent = ALL_GMS.length;
  document.getElementById('sAprov').textContent = ALL_GMS.filter(g => g.status === 'aprovada').length;
  document.getElementById('sCancel').textContent = ALL_GMS.filter(g => g.status === 'cancelada').length;
  filter();
}

function setStatus(s, el) {
  FILTER_STATUS = s;
  document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('on'));
  el.classList.add('on');
  filter();
}

function filter() {
  const q = document.getElementById('search').value.toLowerCase();
  VISIBLE_GMS = ALL_GMS.filter(g => {
    const matchStatus = FILTER_STATUS === 'all' || g.status === FILTER_STATUS;
    const matchSearch = g.num.includes(q) || g.assunto.toLowerCase().includes(q) || g.respTec.toLowerCase().includes(q);
    return matchStatus && matchSearch;
  });

  const tbody = document.getElementById('tbody');
  tbody.innerHTML = VISIBLE_GMS.map((g, idx) => `
    <tr onclick="openMd(${ALL_GMS.indexOf(g)})">
      <td class="td-num">${g.num}</td>
      <td>${g.assunto}</td>
      <td>${g.inicio.split(' ')[0]}</td>
      <td class="td-dur">${g.duracao}</td>
      <td>
        <span class="badge ${g.status === 'aprovada' ? 'badge-aprov' : 'badge-cancel'}">
          <span class="badge-dot"></span>${g.status === 'aprovada' ? 'Aprovada' : 'Cancelada'}
        </span>
      </td>
    </tr>
  `).join('');
}

function openMd(idx) {
  const g = ALL_GMS[idx];
  document.getElementById('mNum').textContent = `GM ¬∑ ${g.num}`;
  document.getElementById('mTit').textContent = g.assunto;
  document.getElementById('mIni').textContent = g.inicio;
  document.getElementById('mDur').textContent = g.duracao;
  document.getElementById('mRtec').textContent = g.respTec;
  
  const motW = document.getElementById('mMotW');
  if (g.status === 'cancelada') {
    motW.style.display = 'block';
    document.getElementById('mMot').textContent = g.motivo;
  } else {
    motW.style.display = 'none';
  }

  document.getElementById('overlay').classList.add('open');
}

function closeMd(e) {
  if (!e || e.target === document.getElementById('overlay')) {
    document.getElementById('overlay').classList.remove('open');
  }
}
</script>
</body>
</html>
