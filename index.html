<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGM Dashboard · Energisa</title>

<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
/* ====== ESTILO ORIGINAL (resumido) ====== */
:root{
  --bg:#0d1117;--surface:#161b22;--surface2:#1c2129;
  --border:#21262d;--accent:#2f81f7;
  --green:#3fb950;--red:#f85149;
  --text:#e6edf3;--text2:#8b949e;
  --font:'Geist',system-ui;--mono:'IBM Plex Mono',monospace
}
*{box-sizing:border-box;margin:0}
body{background:var(--bg);color:var(--text);font-family:var(--font)}
.screen{display:none}.screen.active{display:block}
button{cursor:pointer}

/* simplificado: layout igual ao seu */
</style>
</head>

<body>

<input type="file" id="pdfInput" accept=".pdf">
<button onclick="processPDF()">Processar</button>

<pre id="debug" style="white-space:pre-wrap;color:#8b949e;font-size:11px"></pre>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let ALL_GMS = [];

/* ====== UTIL ====== */
function normalize(items){
  return items.map(i => i.str).join(' ')
    .replace(/\s+/g,' ')
    .trim();
}

function extract(regex, text, group = 1){
  const m = text.match(regex);
  return m ? m[group].trim() : 'Não informado';
}

/* ====== EXTRAÇÃO POR BLOCO ====== */
function parseGMBlock(text){
  const gm = {};

  gm.numero = extract(/número\s+mudança\s*:\s*(\d+)/i, text);
  gm.assunto = extract(/assunto\s*:\s*(.*?)(?=início|$)/i, text);
  gm.inicio  = extract(/início\s+previsto\s*:\s*([\d/: ]+)/i, text);
  gm.termino= extract(/término\s+previsto\s*:\s*([\d/: ]+)/i, text);

  gm.tempoExecucao = extract(
    /tempo\s+(total\s+)?de\s+execução\s*:\s*(.*?)(?=motivo|responsável|$)/i,
    text,
    2
  );

  gm.respTec = extract(
    /responsável\s+técnico\s*:\s*(.*?)(?=sistemas|classificação|$)/i,
    text
  );

  gm.motivoCancelamento = extract(
    /motivo\s+do\s+cancelamento\s*:\s*(.*?)(?=tempo|responsável|$)/i,
    text
  );

  gm.status = /cancelad/i.test(text) ? 'Cancelada' : 'Aprovada';

  return gm;
}

/* ====== PROCESSAMENTO ====== */
async function processPDF(){
  const file = document.getElementById('pdfInput').files[0];
  if(!file) return alert('Selecione um PDF');

  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:buf}).promise;

  let fullText = '';
  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    fullText += '\n' + normalize(content.items);
  }

  /* DEBUG */
  document.getElementById('debug').textContent = fullText;

  /* SPLIT POR GM */
  const blocks = fullText.split(/número\s+mudança\s*:/i).slice(1);

  ALL_GMS = blocks.map(b => parseGMBlock(b));

  console.table(ALL_GMS);
  alert(`Extraídas ${ALL_GMS.length} GMs`);
}
</script>

</body>
</html>
