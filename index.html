<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let ALL_GMS = [];
let VISIBLE_GMS = [];
let FILTER_STATUS = 'all';

/* ================= UTIL ================= */
function normalize(items) {
  return items.map(i => i.str).join(' ')
    .replace(/\s+/g, ' ')
    .trim();
}

function extract(regex, text, group = 1) {
  const m = text.match(regex);
  return m ? m[group].trim() : '—';
}

/* ================= SPLIT CERTO ================= */
function splitGMs(text) {
  const rx = /número\s+mudança\s*:\s*\d+/ig;
  const matches = [...text.matchAll(rx)];
  const blocks = [];

  for (let i = 0; i < matches.length; i++) {
    const start = matches[i].index;
    const end = matches[i + 1]?.index || text.length;
    blocks.push(text.slice(start, end));
  }
  return blocks;
}

/* ================= PARSER GM ================= */
function parseGMBlock(text) {
  const gm = {};

  gm.num = extract(/número\s+mudança\s*:\s*(\d+)/i, text);
  gm.assunto = extract(/assunto\s*:\s*(.*?)(?=início\s+previsto|categoria|$)/i, text);
  gm.inicio = extract(/início\s+previsto\s*:\s*([\d/: ]+)/i, text);
  gm.termino = extract(/término\s+previsto\s*:\s*([\d/: ]+)/i, text);

  gm.duracao = extract(
    /duração\s+prevista\s*:\s*(.*?)(?=responsável|$)/i,
    text
  );

  gm.respTec = extract(
    /responsável\s+técnico\s*:\s*(.*?)(?=sistemas|classificação|$)/i,
    text
  );

  gm.motivo = extract(
    /motivo\s+do\s+cancelamento\s*:\s*(.*?)(?=início|responsável|$)/i,
    text
  );

  gm.status = /cancelad/i.test(text) ? 'cancelada' : 'aprovada';

  return gm;
}

/* ================= PROCESS ================= */
async function process() {
  const file = document.getElementById('pdfInput').files[0];
  if (!file) return;

  document.getElementById('screenUpload').classList.remove('active');
  document.getElementById('screenLoading').classList.add('active');

  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;

  let fullText = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    fullText += ' ' + normalize(content.items);
  }

  const blocks = splitGMs(fullText);
  ALL_GMS = blocks.map(parseGMBlock);

  document.getElementById('screenLoading').classList.remove('active');
  document.getElementById('screenDash').classList.add('active');

  renderDash();
}

/* ================= DASH ================= */
function renderDash() {
  document.getElementById('sTotal').textContent = ALL_GMS.length;
  document.getElementById('sAprov').textContent =
    ALL_GMS.filter(g => g.status === 'aprovada').length;
  document.getElementById('sCancel').textContent =
    ALL_GMS.filter(g => g.status === 'cancelada').length;

  filter();
}

function setStatus(st, el) {
  FILTER_STATUS = st;
  document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('on'));
  el.classList.add('on');
  filter();
}

function filter() {
  const q = document.getElementById('search').value.toLowerCase();

  VISIBLE_GMS = ALL_GMS.filter(g => {
    const okStatus = FILTER_STATUS === 'all' || g.status === FILTER_STATUS;
    const okSearch =
      g.num.includes(q) || g.assunto.toLowerCase().includes(q);
    return okStatus && okSearch;
  });

  renderTable();
}

/* ================= TABLE ================= */
function renderTable() {
  const tb = document.getElementById('tbody');
  tb.innerHTML = '';

  VISIBLE_GMS.forEach(g => {
    const tr = document.createElement('tr');
    tr.onclick = () => openMd(g);
    tr.innerHTML = `
      <td class="td-num">${g.num}</td>
      <td>${g.assunto}</td>
      <td>${g.inicio}</td>
      <td class="td-dur">${g.duracao}</td>
      <td>
        <span class="badge ${g.status === 'cancelada' ? 'badge-cancel' : 'badge-aprov'}">
          <span class="badge-dot"></span>${g.status}
        </span>
      </td>`;
    tb.appendChild(tr);
  });
}

/* ================= MODAL ================= */
function openMd(g) {
  document.getElementById('mNum').textContent = `GM ${g.num}`;
  document.getElementById('mTit').textContent = g.assunto;
  document.getElementById('mIni').textContent = g.inicio;
  document.getElementById('mDur').textContent = g.duracao;
  document.getElementById('mRtec').textContent = g.respTec;

  const mw = document.getElementById('mMotW');
  if (g.status === 'cancelada' && g.motivo !== '—') {
    document.getElementById('mMot').textContent = g.motivo;
    mw.style.display = 'block';
  } else {
    mw.style.display = 'none';
  }

  document.getElementById('overlay').classList.add('open');
}

function closeMd(e) {
  if (e.target.id === 'overlay')
    document.getElementById('overlay').classList.remove('open');
}
</script>
